<html>
<head>
  <title>Test Serialze</title>
</head>
<style>
  #pre_serialze {
    border-style:solid;
    border-width:1px;
    border-color: red;
  }

  #post_serialze {
    border-style:solid;
    border-width:1px;
    border-color: green;
  }
</style>
<body>
  <h1>Pre-serialze</h1>
  <div id="pre_serialze">
    <h2 name="tea_list">List of my favourite teas</h2>
    <img src="images/om.jpeg"></img>
    <ul>
      <li>Earl Grey</li>
      <li>Yorkshire Tea</li>
      <li>Green Tea</li>
      <li>Darjeeling</li>
    </ul>
  </div>
  <a href="javascript:btnSerialize()">serialize</a>

  <h1>Post-serialze</h1>
  <div id="post_serialze">Nothing here yet!</div>

<script>
/*
	// http://stackoverflow.com/questions/2888812/save-html-5-canvas-to-a-file-in-chrome
	// http://stackoverflow.com/questions/934012/get-image-data-in-javascript
	function getImageData(_src, _callback) {
		var img = new Image();
		img.onload = function() {
			// Create an empty canvas element
			var canvas = document.createElement("canvas");
			canvas.width = img.width;
			canvas.height = img.height;

			// Copy the image contents to the canvas
			var ctx = canvas.getContext("2d");
			ctx.drawImage(img, 0, 0);

			var dataURL = canvas.toDataURL("image/jpeg");
			_callback.ok(_src, dataURL);
		}
		img.onerror = function() {
			_callback.err("getImageData: Failed!");
		}
		img.src = _src;
	}

  function btnSerialize() {
    var preDiv  = document.getElementById("pre_serialze");
    var postDiv = document.getElementById("post_serialze");
    serialize(preDiv, postDiv)
  }

  function imgFlatten(node, callback) {
    console.log("flattening: "+node.src)
    getImageData(node.src, {
      ok: function(src, dataURL) {
        console.log("OK!!!")
        node.src = dataURL;
        callback();
      },
      err: function(msg) {
        console.log("ERROR!!!")
        console.log(msg)
        callback();
      }
    })
  }

  function processNode(node, callback) {
    // Flatten with each 
    switch(node.tagName) {
      case 'IMG':
        imgFlatten(node, function() {
          callback(node);
        });
        break;
      default:
        callback(node);
    }
  }


  var walkDOM = function walk(node, func, depth) {
      depth = ++depth || 0;
      func(node);

      node = node.firstChild;
      while (node) {
          walk(node, func, depth);
          node = node.nextSibling;
      }
  };

  // http://snipplr.com/view/19815/walking-the-dom
  function flattenDOMTree(node, callback, depth) {
    var nodeId = 0;

    // Walk the dom.
    walkDOM(node, function(node) {
      nodeId++;
      processNode(node, function() {
        nodeId--;
        if(nodeId == 0) {
          callback();
        }
      });
    });
  }

    
  function cloneChildren(fromNode, toNode) {
    // Copy all child nodes.
    for (var n=0; n<fromNode.childNodes.length; n++) {
      toNode.appendChild(
        fromNode.childNodes[n].cloneNode(true)
      )
    }
  }

  function serialize(preNode, postNode) {
    var tmpNode = document.createElement('div');
    cloneChildren(preNode, tmpNode);

    flattenDOMTree(tmpNode, function() {
      console.log("Node serialized.");
      postNode.innerHTML = tmpNode.innerHTML;
    });
  }
*/


  ////////////////////////////////////////////////////

  function DOMSerializer(node) {
    this.node = node;
  }

	DOMSerializer._getImageData = function(src, callback) {
		var img = new Image();
		img.onload = function() {
			// Create an empty canvas element
			var canvas = document.createElement("canvas");
			canvas.width = img.width;
			canvas.height = img.height;

			// Copy the image contents to the canvas
			var ctx = canvas.getContext("2d");
			ctx.drawImage(img, 0, 0);

			var dataURL = canvas.toDataURL("image/jpeg");
			callback.ok(dataURL);
		}
		img.onerror = function() {
			callback.err("getImageData: Failed!");
		}
		img.src = src;
	}

  
  // Process each rules function for the node sequentially
  //   NOTE: This performs tail recursion on the rules array.
  DOMSerializer.prototype._processNodeRules = function(node, rules, callback) {
    thisObj = this;

    var rule = rules.pop();
    if(rule) {
      rule(node, function() {
        thisObj._processNodeRules(node, rules, callback);
      })
    } else {
      callback();
    }
  }

  DOMSerializer.prototype.processNode = function(node, callback) {
    // Flatten node node with it own rules. Rule funcs defined below.
    var rules = [
      this.processorSTYLE
    ]

    func = eval("this.processor"+node.tagName);
    if (func) {
      rules.push(func);
    }

    this._processNodeRules(node, rules, function() {
      callback(node);
    });
  }

  //
  // Node processing functions.
  //
  DOMSerializer.prototype.processorIMG = function(node, callback) {
    DOMSerializer._getImageData(node.src, {
      ok: function(dataURL) {
        node.src = dataURL;
        callback();
      },
      err: function(msg) {
        callback()
      }
    })
  }

  DOMSerializer.prototype.processorSTYLE = function(node, callback) {
    console.log(node.style);
    callback();
  }


  DOMSerializer.prototype.walkDOM = function(node, func, depth) {
      depth = ++depth || 0;
      func(node);

      node = node.firstChild;
      while (node) {
          this.walkDOM(node, func, depth);
          node = node.nextSibling;
      }
  };

  // http://snipplr.com/view/19815/walking-the-dom
  DOMSerializer.prototype.flattenDOMTree = function(node, callback) {
    var nodeId = 0;

    // Walk the dom.
    var thisObj = this;
    this.walkDOM(node, function(node) {
      nodeId++;
      thisObj.processNode(node, function() {
        nodeId--;
        if(nodeId == 0) {
          callback();
        }
      });
    });
  }

  DOMSerializer.prototype.cloneChildren = function(fromNode, toNode) {
    // Copy all child nodes.
    for (var n=0; n<fromNode.childNodes.length; n++) {
      toNode.appendChild(
        fromNode.childNodes[n].cloneNode(true)
      )
    }
  }

  DOMSerializer.prototype.flatten = function(callback) {
    var tmpNode = document.createElement('div');
    this.cloneChildren(this.node, tmpNode);

    this.flattenDOMTree(tmpNode, function() {
      console.log("Node serialized.");
      callback(tmpNode.innerHTML);
    });
  }


  function btnSerialize() {
    var preDiv  = document.getElementById("pre_serialze");
    var postDiv = document.getElementById("post_serialze");

    new DOMSerializer(preDiv).flatten(function(html) {
      postDiv.innerHTML = html;
    });
  }

</script>
</body>
</html>



